<?php

define('MATCHES_PER_SLIP', 10);

/**
 * Implements hook_menu()
 */
function quinieleitor_menu() {
  $items = array();
  $items['admin/quinieleitor/add'] = array(
    'title' => 'Add a betting slip',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('quinieleitor_add_betting_slip_form'),
    'access arguments' => array('add betting slips'),
    'file' => 'quinieleitor.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/quinieleitor/resolve'] = array(
    'title' => 'Resolve a betting slip',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('quinieleitor_resolve_betting_slip_form'),
    'access arguments' => array('resolve betting slips'),
    'file' => 'quinieleitor.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['bet'] = array(
    'title' => 'Access to the current betting slip',
    'page callback' => 'quinieleitor_bet_page',
    'access arguments' => array('bet'),
    'file' => 'quinieleitor.pages.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}


/**
 * Implements hook_perm()
 */
function quinieleitor_perm() {
  return array('add betting slips', 'resolve betting slips', 'bet');
}


function quinieleitor_load_current_slip() {
  $results = db_query('SELECT * FROM {betting_slips} WHERE date>NOW() AND closed=0 ORDER BY date ASC LIMIT 1');
  $slip = db_fetch_object($results);
  if ($slip) {
    $slip->matches = quinieleitor_load_slip_matches($slip->id);
  }

  return $slip;
}


function quinieleitor_load_slip($slip_id) {
  $results = db_query('SELECT * FROM {betting_slips} WHERE id=%d', $slip_id);
  $slip = db_fetch_object($results);
  if ($slip) {
    $slip->matches = quinieleitor_load_slip_matches($slip->id);
  }

  return $slip;
}


function quinieleitor_load_better_slip($uid, $slip_id) {
  $results = db_query('SELECT b.* FROM {bets} b JOIN {matches} m ON b.match_id=m.id WHERE b.user_id=%d AND m.slip_id=%d ORDER BY m.id ASC', $uid, $slip_id);
  $bet = new stdClass();
  $bet->slip_id = $slip_id;
  $bet->matches = array();
  while ($match = db_fetch_object($results)) {
    $bet->matches[] = $match;
  }

  return $bet;
}


function quinieleitor_load_betting_slips() {
  $slips = array();
  $results = db_query('SELECT * FROM {betting_slips} ORDER BY date ASC');
  while ($slip = db_fetch_object($results)) {
    $slip->matches = quinieleitor_load_slip_matches($slip->id);
    $slips[] = $slip;
  }
  return $slips;
}


function quinieleitor_load_slip_matches($slip_id) {
  $matches = array();
  $results = db_query('SELECT * FROM {matches} WHERE slip_id=%d ORDER BY id ASC', $slip_id);
  while ($match = db_fetch_object($results)) {
    $matches[] = $match;
  }

  return $matches;
}

function quinieleitor_save_betting_slip($betting_slip) {
  drupal_write_record('betting_slips', $betting_slip);
  foreach ($betting_slip->matches as $match) {
    $match->slip_id = $betting_slip->id;
    drupal_write_record('matches', $match);
  }
}


function quinieleitor_save_bet($bet) {
  foreach ($bet->matches as $match_bet) {
    drupal_write_record('bets', $match_bet);
  }
}
